{%- assign default_lang = site.default_lang | downcase -%}
{%- assign languages    = site.languages -%}

{%- assign parts = page.url | split: "/" -%}
{%- assign first = parts[1] | downcase -%}

{%- if languages contains first and first != default_lang -%}
  {%- assign path_without_lang = parts | slice: 2, parts.size | join: "/" -%}
{%- else -%}
  {%- assign path_without_lang = parts | slice: 1, parts.size | join: "/" -%}
{%- endif -%}

{%- if path_without_lang != "" and path_without_lang != "/" -%}
  {%- assign normalized_path = "/" | append: path_without_lang -%}
{%- else -%}
  {%- assign normalized_path = "/" -%}
{%- endif -%}

{%- assign trail = "" -%}
{%- if page.url | slice: -1, 1 == "/" -%}{%- assign trail = "/" -%}{%- endif -%}
{%- if trail == "/" and normalized_path != "/" and normalized_path | slice: -1, 1 != "/" -%}
  {%- assign normalized_path = normalized_path | append: "/" -%}
{%- endif -%}

{%- assign baseurl = site.baseurl | default: "" -%}

<div class="lang-switcher" style="margin:0;">
  {%- for lang in languages -%}
    {%- assign lc = lang | downcase -%}
    {%- if lc == default_lang -%}
      {%- assign href = baseurl | append: normalized_path -%}
    {%- else -%}
      {%- assign href = baseurl | append: "/" | append: lc | append: normalized_path -%}
    {%- endif -%}
    <a href="{{ href }}">{{ lc | upcase }}</a>{% unless forloop.last %}<span aria-hidden="true" style="opacity:.35;margin:0 .25rem;">|</span>{% endunless %}
  {%- endfor -%}
</div>
