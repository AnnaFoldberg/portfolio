{%- comment -%}
Language switcher for jekyll-polyglot
- Default language has no prefix
- Other languages use /<lang>/
- Keep same path if it exists in target language, otherwise fall back to that language's home
- Correctly highlight active language
{%- endcomment -%}

{%- assign default_lang = site.default_lang | downcase -%}
{%- assign active_lang  = page.lang | default: site.active_lang | downcase -%}

{%- assign url = page.url -%}
{%- assign trail = '' -%}
{%- if url | slice: -1, 1 == '/' -%}{%- assign trail = '/' -%}{%- endif -%}

{%- assign parts = url | split:'/' -%}
{%- assign first = parts[1] | downcase -%}

{%- if site.languages contains first and first != default_lang -%}
  {%- assign path_without_lang = parts | slice: 2, parts.size | join:'/' -%}
{%- else -%}
  {%- assign path_without_lang = parts | slice: 1, parts.size | join:'/' -%}
{%- endif -%}

{%- if path_without_lang != '' and path_without_lang != '/' -%}
  {%- assign normalized_path = '/' | append: path_without_lang -%}
{%- else -%}
  {%- assign normalized_path = '/' -%}
{%- endif -%}

{%- comment -%} Collect all docs (pages + collections) {%- endcomment -%}
{%- assign _all_docs = site.pages -%}
{%- for c in site.collections -%}
  {%- assign _all_docs = _all_docs | concat: c.docs -%}
{%- endfor -%}

{%- assign baseurl = site.baseurl | default: '' -%}

<div class="lang-switcher" style="margin:0;">
  {%- for lang in site.languages -%}
    {%- assign lang_lc = lang | downcase -%}

    {%- if lang_lc == default_lang -%}
      {%- assign candidate_path = normalized_path -%}
    {%- else -%}
      {%- assign candidate_path = '/' | append: lang_lc | append: normalized_path -%}
    {%- endif -%}

    {%- comment -%} ensure trailing slash consistency (replace endswith check) {%- endcomment -%}
    {%- if trail == '/' and candidate_path != '/' -%}
      {%- assign last_char = candidate_path | slice: -1, 1 -%}
      {%- if last_char != '/' -%}
        {%- assign candidate_path = candidate_path | append:'/' -%}
      {%- endif -%}
    {%- endif -%}

    {%- assign exists = false -%}
    {%- for d in _all_docs -%}
      {%- if d.url == candidate_path -%}
        {%- assign exists = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}

    {%- if exists == false -%}
      {%- if lang_lc == default_lang -%}
        {%- assign candidate_path = '/' -%}
      {%- else -%}
        {%- assign candidate_path = '/' | append: lang_lc | append: '/' -%}
      {%- endif -%}
    {%- endif -%}

    {%- assign href = baseurl | append: candidate_path -%}

    {%- if lang_lc == active_lang -%}
      <span style="font-weight:600;">{{ lang | upcase }}</span>
    {%- else -%}
      <a href="{{ href }}">{{ lang | upcase }}</a>
    {%- endif -%}

    {%- unless forloop.last -%}<span aria-hidden="true" style="opacity:.35;margin:0 .25rem;">|</span>{%- endunless -%}
  {%- endfor -%}
</div>
