{%- comment -%}
  _includes/lang-switcher.html
{%- endcomment -%}

{%- assign default_lang = site.default_lang | downcase -%}
{%- assign languages    = site.languages -%}
{%- assign baseurl      = site.baseurl | default: "" -%}

{%- comment %}
  1) Determine current language: prefer page.lang, else infer from first URL segment.
{%- endcomment -%}
{%- if page.lang -%}
  {%- assign current_lang = page.lang | downcase -%}
{%- else -%}
  {%- assign current_lang = default_lang -%}
  {%- assign parts = page.url | split: "/" -%}
  {%- assign first = parts[1] | downcase -%}
  {%- for L in languages -%}
    {%- assign lc = L | downcase -%}
    {%- if first == lc -%}
      {%- assign current_lang = lc -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- comment %}
  2) Compute path WITHOUT any lang prefix (so switching keeps you on the same page).
{%- endcomment -%}
{%- assign parts = page.url | split: "/" -%}
{%- assign first = parts[1] | downcase -%}
{%- assign has_any_prefix = false -%}
{%- for L in languages -%}
  {%- assign lc = L | downcase -%}
  {%- if first == lc -%}{%- assign has_any_prefix = true -%}{%- endif -%}
{%- endfor -%}

{%- if has_any_prefix -%}
  {%- assign path_without_lang = parts | slice: 2, parts.size | join: "/" -%}
{%- else -%}
  {%- assign path_without_lang = parts | slice: 1, parts.size | join: "/" -%}
{%- endif -%}

{%- if path_without_lang == "" -%}
  {%- assign normalized_path = "/" -%}
{%- else -%}
  {%- assign normalized_path = "/" | append: path_without_lang -%}
  {%- comment %} Preserve trailing slash if current page has one {%- endcomment -%}
  {%- if page.url != "/" and page.url | slice: -1, 1 == "/" and normalized_path | slice: -1, 1 != "/" -%}
    {%- assign normalized_path = normalized_path | append: "/" -%}
  {%- endif -%}
{%- endif -%}

<div class="lang-switcher" style="margin:0;">
  {%- for L in languages -%}
    {%- assign lc = L | downcase -%}
    {%- assign label = lc | upcase -%}

    {%- if lc == current_lang -%}
      <strong aria-current="true">{{ label }}</strong>
    {%- else -%}
      {%- if lc == default_lang -%}
        {%- assign href = baseurl | append: normalized_path -%}
      {%- else -%}
        {%- assign href = baseurl | append: "/" | append: lc | append: normalized_path -%}
      {%- endif -%}
      <a href="{{ href }}">{{ label }}</a>
    {%- endif -%}

    {%- unless forloop.last -%}
      <span aria-hidden="true" style="opacity:.35;margin:0 .25rem;">|</span>
    {%- endunless -%}
  {%- endfor -%}
</div>
