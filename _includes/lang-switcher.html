{%- comment -%}
Robust language switcher for jekyll-polyglot.

- Keeps the current page path when switching language.
- Default language (site.default_lang) has no prefix (no /en).
- Non-default languages get /<lang>/ prefix.
- Correctly highlights the active language (page.lang preferred).

Assumes:
  site.languages: ["en","da","it"]
  site.default_lang: "en"
{%- endcomment -%}

{%- assign active_lang = page.lang | default: site.active_lang -%}
{%- assign parts = page.url | split: '/' -%}
{%- assign first = parts[1] -%}

{%- comment -%}
If first segment IS a language (and not the default), strip it.
Examples:
  /da/projects/foo/  -> path_without_lang = projects/foo/
  /projects/foo/     -> path_without_lang = projects/foo/
{%- endcomment -%}
{%- if site.languages contains first and first != site.default_lang -%}
  {%- assign path_without_lang = parts | slice: 2, parts.size | join: '/' -%}
{%- else -%}
  {%- assign path_without_lang = parts | slice: 1, parts.size | join: '/' -%}
{%- endif -%}

{%- comment -%}
Normalize leading slash for the path part weâ€™ll append after the (optional) lang prefix.
{%- endcomment -%}
{%- if path_without_lang != '' and path_without_lang != '/' -%}
  {%- assign normalized_path = '/' | append: path_without_lang -%}
{%- else -%}
  {%- assign normalized_path = '/' -%}
{%- endif -%}

<div class="lang-switcher" style="margin:0;">
  {%- for lang in site.languages -%}
    {%- if lang == site.default_lang -%}
      {%- assign href = normalized_path | relative_url -%}
    {%- else -%}
      {%- assign href = '/' | append: lang | append: normalized_path | relative_url -%}
    {%- endif -%}

    {%- if lang == active_lang -%}
      <span style="font-weight:600;">{{ lang | upcase }}</span>
    {%- else -%}
      <a href="{{ href }}">{{ lang | upcase }}</a>
    {%- endif -%}

    {%- unless forloop.last -%}<span aria-hidden="true" style="opacity:.35;margin:0 .25rem;">|</span>{%- endunless -%}
  {%- endfor -%}
</div>
