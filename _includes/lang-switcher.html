{%- assign default_lang = site.default_lang | downcase -%}
{%- assign languages    = site.languages -%}
{%- assign baseurl      = site.baseurl | default: "" -%}

{%- comment %} Split the current URL {%- endcomment -%}
{%- assign parts = page.url | split: "/" -%}
{%- assign first = parts[1] | downcase -%}

{%- comment %} Detect if the URL is prefixed with a non-default language (case-insensitive) {%- endcomment -%}
{%- assign has_prefix = false -%}
{%- assign current_lang = default_lang -%}
{%- for L in languages -%}
  {%- assign lc = L | downcase -%}
  {%- if first == lc and lc != default_lang -%}
    {%- assign has_prefix = true -%}
    {%- assign current_lang = lc -%}
  {%- endif -%}
{%- endfor -%}

{%- comment %} Strip lang from path when present; otherwise keep as-is {%- endcomment -%}
{%- if has_prefix -%}
  {%- assign path_without_lang = parts | slice: 2, parts.size | join: "/" -%}
{%- else -%}
  {%- assign path_without_lang = parts | slice: 1, parts.size | join: "/" -%}
{%- endif -%}

{%- comment %} Normalize and preserve trailing slash to mirror current page {%- endcomment -%}
{%- if path_without_lang == "" -%}
  {%- assign normalized_path = "/" -%}
{%- else -%}
  {%- assign normalized_path = "/" | append: path_without_lang -%}
  {%- if page.url != "/" and page.url | slice: -1, 1 == "/" and normalized_path | slice: -1, 1 != "/" -%}
    {%- assign normalized_path = normalized_path | append: "/" -%}
  {%- endif -%}
{%- endif -%}

<div class="lang-switcher" style="margin:0;">
  {%- for L in languages -%}
    {%- assign lc = L | downcase -%}
    {%- assign label = lc | upcase -%}

    {%- if lc == current_lang -%}
      <strong aria-current="true">{{ label }}</strong>
    {%- else -%}
      {%- if lc == default_lang -%}
        {%- assign href = baseurl | append: normalized_path -%}
      {%- else -%}
        {%- assign href = baseurl | append: "/" | append: lc | append: normalized_path -%}
      {%- endif -%}
      <a href="{{ href }}">{{ label }}</a>
    {%- endif -%}

    {%- unless forloop.last -%}
      <span aria-hidden="true" style="opacity:.35;margin:0 .25rem;">|</span>
    {%- endunless -%}
  {%- endfor -%}
</div>
