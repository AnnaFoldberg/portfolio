{%- comment -%}
Lang Switcher (polyglot-aware, robust)
- Current language = page.lang (fallback: site.active_lang, site.default_lang)
- Finds counterpart in site.pages by ref (index/normal pages)
- Finds counterpart in the current collection by ref/slug (collection items)
- Default language uses "/" as home; others use "/<lang>/"
{%- endcomment -%}

{%- assign current_lang = page.lang | default: site.active_lang | default: site.default_lang -%}
{%- assign langs = site.languages -%}

<ul class="lang-switcher">
{%- for L in langs -%}
  {%- comment -%} Display label (from _data/locales/<L>.yml if present) {%- endcomment -%}
  {%- assign label = L | upcase -%}
  {%- if site.data.locales and site.data.locales[L] and site.data.locales[L].lang_name -%}
    {%- assign label = site.data.locales[L].lang_name -%}
  {%- endif -%}

  {%- assign target_url = nil -%}

  {%- comment -%} 1) Try pages (great for collection index/normal pages) {%- endcomment -%}
  {%- if page.ref -%}
    {%- assign page_matches = site.pages | where: "lang", L | where: "ref", page.ref -%}
    {%- assign page_candidate = page_matches | first -%}
    {%- if page_candidate and page_candidate.url -%}
      {%- assign target_url = page_candidate.url -%}
    {%- endif -%}
  {%- endif -%}

  {%- comment -%} 2) Try the collection (for collection items) {%- endcomment -%}
  {%- if target_url == nil and page.collection -%}
    {%- assign items = site[page.collection] | where: "lang", L -%}
    {%- assign candidate = nil -%}

    {%- if page.ref -%}
      {%- assign candidate = items | where: "ref", page.ref | first -%}
    {%- endif -%}

    {%- if candidate == nil -%}
      {%- assign pslug = page.slug | default: page.name | split: "." | first -%}
      {%- assign candidate = items | where: "slug", pslug | first -%}
    {%- endif -%}

    {%- if candidate and candidate.url -%}
      {%- assign target_url = candidate.url -%}
    {%- endif -%}
  {%- endif -%}

  {%- comment -%} 3) Fallback to language home (default -> "/") {%- endcomment -%}
  {%- if target_url == nil -%}
    {%- if L == site.default_lang -%}
      {%- assign target_url = "/" -%}
    {%- else -%}
      {%- assign target_url = "/" | append: L | append: "/" -%}
    {%- endif -%}
  {%- endif -%}

  <li class="lang-item">
    {%- if L == current_lang -%}
      <strong aria-current="true">{{ label }}</strong>
    {%- else -%}
      <a href="{{ target_url | relative_url }}" hreflang="{{ L }}">{{ label }}</a>
    {%- endif -%}
  </li>
{%- endfor -%}
</ul>
