{%- comment -%}
Lang Switcher (step 1: no active-state logic)
- Builds links for each language only
- Tries to find counterparts by ref/slug (pages & collections)
- Falls back to language homes (default -> "/", others -> "/<lang>/")
{%- endcomment -%}

{%- assign langs = site.languages -%}

<ul class="lang-switcher">
{%- for L in langs -%}
  {%- assign Lnorm = L | downcase -%}

  {%- comment -%} Optional human label from _data/locales/<L>.yml {%- endcomment -%}
  {%- assign label = L | upcase -%}
  {%- if site.data.locales and site.data.locales[Lnorm] and site.data.locales[Lnorm].lang_name -%}
    {%- assign label = site.data.locales[Lnorm].lang_name -%}
  {%- endif -%}

  {%- assign target_url = nil -%}

  {%- comment -%} 1) Try matching a normal page by ref {%- endcomment -%}
  {%- if page.ref -%}
    {%- assign candidate = site.pages | where: "lang", Lnorm | where: "ref", page.ref | first -%}
    {%- if candidate and candidate.url -%}
      {%- assign target_url = candidate.url -%}
    {%- endif -%}
  {%- endif -%}

  {%- comment -%} 2) Try matching within the current collection (for collection items) {%- endcomment -%}
  {%- if target_url == nil and page.collection -%}
    {%- assign items = site[page.collection] | where: "lang", Lnorm -%}
    {%- assign cand = nil -%}
    {%- if page.ref -%}
      {%- assign cand = items | where: "ref", page.ref | first -%}
    {%- endif -%}
    {%- if cand == nil -%}
      {%- assign pslug = page.slug | default: page.name | split: "." | first -%}
      {%- assign cand = items | where: "slug", pslug | first -%}
    {%- endif -%}
    {%- if cand and cand.url -%}
      {%- assign target_url = cand.url -%}
    {%- endif -%}
  {%- endif -%}

  {%- comment -%} 3) Fallback to language home (default -> "/") {%- endcomment -%}
  {%- if target_url == nil -%}
    {%- if Lnorm == site.default_lang -%}
      {%- assign target_url = "/" -%}
    {%- else -%}
      {%- capture target_url -%}/{{ Lnorm }}/{%- endcapture -%}
    {%- endif -%}
  {%- endif -%}

  <li class="lang-item">
    <a href="{{ target_url | relative_url }}" hreflang="{{ Lnorm }}">{{ label }}</a>
  </li>
{%- endfor -%}
</ul>
