{% capture logo_path %}{{ site.logo }}{% endcapture %}
<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">

        {%- comment -%}
        Resolve language ONCE from URL; never rely on mutable globals.
        Accept only en/da/it; otherwise hard-fallback to 'en'.
        {%- endcomment -%}
        {%- assign __mh_segments = page.url | split:'/' -%}
        {%- assign __mh_candidate = __mh_segments[1] | downcase -%}
        {%- if __mh_candidate == 'en' or __mh_candidate == 'da' or __mh_candidate == 'it' -%}
          {%- assign __mh_lang = __mh_candidate -%}
        {%- else -%}
          {%- assign __mh_lang = 'en' -%}
        {%- endif -%}

        {%- comment -%} Language-specific root like "/it/" {%- endcomment -%}
        {%- assign __mh_home = '/' | append: __mh_lang | append: '/' -%}

        {%- comment -%}
        Pull localized nav items with hard fallbacks.
        {%- endcomment -%}
        {%- assign __mh_loc = site.data.locales[__mh_lang]
          | default: site.data.locales.en -%}
        {%- assign __mh_items = __mh_loc.main
          | default: site.data.locales.en.main -%}

        {%- comment -%} Logo (links to language root) {%- endcomment -%}
        {% unless logo_path == empty %}
          <a class="site-logo" href="{{ __mh_home | relative_url }}">
            <img src="{{ logo_path | relative_url }}" alt="{{ site.masthead_title | default: site.title }}">
          </a>
        {% endunless %}

        {%- comment -%} Site title (links to language root) {%- endcomment -%}
        <a class="site-title" href="{{ __mh_home | relative_url }}">
          {{ site.masthead_title | default: site.title }}
          {% if site.subtitle %}
            <span class="site-subtitle">{{ site.subtitle }}</span>
          {% endif %}
        </a>

        {%- comment -%}
        Render the NAV MENU *before* any includes, using only our local vars.
        {%- endcomment -%}
        {%- if __mh_items -%}
          <ul class="visible-links">
            {%- for __mh_link in __mh_items -%}
              {%- assign __mh_path = __mh_link.url | remove_first:'/' -%}
              <li class="masthead__menu-item">
                <a href="{{ __mh_home | append: __mh_path | relative_url }}">{{ __mh_link.title }}</a>
              </li>
            {%- endfor -%}
          </ul>
        {%- endif -%}

        {%- comment -%}
        Mobile overflow toggle label (optional localization).
        Uses the same resolved language; safe fallbacks to English.
        {%- endcomment -%}
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">
            {{ site.data.ui-text[__mh_lang].menu_label
               | default: site.data.ui-text.en.menu_label
               | default: "Toggle menu" }}
          </span>
          <div class="navicon"></div>
        </button>

        <ul class="hidden-links hidden"></ul>

        {%- comment -%}
        Finally include the language switcher.
        It canâ€™t affect the already-rendered menu or overwrite our local vars.
        {%- endcomment -%}
        <div class="lang-switcher--masthead">
          {% include lang-switcher.html current_lang=__mh_lang %}
        </div>

      </nav>
    </div>
  </div>
</div>
